generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==========================================
// ENUMS
// ==========================================

enum UserRole {
  CLIENT
  PROVIDER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BANNED
}

enum SocialProvider {
  GOOGLE
  FACEBOOK
  APPLE
}

enum DevicePlatform {
  ANDROID
  IOS
}

enum VerificationStatus {
  PENDING_DOCUMENTS
  DOCUMENTS_SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  SUSPENDED
}

enum DocumentType {
  CEDULA_FRONT
  CEDULA_BACK
  SELFIE_WITH_CEDULA
  RUT
  CERTIFICATION
  ANTECEDENTES
  BANK_CERTIFICATE
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum BackgroundCheckStatus {
  PENDING
  IN_PROGRESS
  PASSED
  FAILED
}

enum BankAccountType {
  SAVINGS
  CHECKING
  NEQUI
  DAVIPLATA
}

enum DocumentIdType {
  CC
  NIT
}

enum BookingStatus {
  REQUESTED
  QUOTED
  ACCEPTED
  PROVIDER_EN_ROUTE
  IN_PROGRESS
  EVIDENCE_UPLOADED
  COMPLETED
  CANCELLED
  DISPUTED
}

enum CancelledBy {
  CLIENT
  PROVIDER
  ADMIN
  SYSTEM
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  PSE
  NEQUI
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  REFUNDED
  PARTIALLY_REFUNDED
  FAILED
  EXPIRED
}

enum EvidenceType {
  BEFORE
  DURING
  AFTER
  DISPUTE
}

enum PqrsType {
  PETITION
  COMPLAINT
  CLAIM
  SUGGESTION
}

enum PqrsStatus {
  OPEN
  IN_REVIEW
  WAITING_RESPONSE
  ESCALATED
  RESOLVED
  REOPENED
  CLOSED
}

enum PqrsPriority {
  HIGH
  MEDIUM
  LOW
}

enum PqrsResolutionType {
  FULL_REFUND
  PARTIAL_REFUND
  NO_REFUND
  CREDIT
  SUSPENSION
}

enum SenderRole {
  CLIENT
  PROVIDER
  ADMIN
}

enum NotificationType {
  BOOKING_UPDATE
  PAYMENT
  PQRS
  REVIEW
  SYSTEM
}

enum ChatMessageType {
  TEXT
  IMAGE
  SYSTEM
}

// ==========================================
// MODELS
// ==========================================

model User {
  id            String     @id @default(uuid()) @db.Uuid
  email         String     @unique
  passwordHash  String?
  firstName     String
  lastName      String
  phone         String?    @unique
  phoneVerified Boolean    @default(false)
  avatarUrl     String?
  role               UserRole   @default(CLIENT)
  status             UserStatus @default(ACTIVE)
  wantsToBeProvider  Boolean    @default(false)
  activeMode         UserRole   @default(CLIENT)
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  // Relations
  socialAccounts SocialAccount[]
  deviceTokens   DeviceToken[]
  provider       Provider?
  bookingsAsClient Booking[]        @relation("ClientBookings")
  reviews          Review[]
  pqrsTicketsCreated PqrsTicket[]   @relation("PqrsCreatedBy")
  pqrsTicketsAssigned PqrsTicket[]  @relation("PqrsAssignedTo")
  pqrsMessages     PqrsMessage[]
  notifications    Notification[]
  chatMessages     ChatMessage[]
  evidencesUploaded Evidence[]
  bookingStatusChanges BookingStatusHistory[]

  @@map("users")
}

model SocialAccount {
  id         String         @id @default(uuid()) @db.Uuid
  userId     String         @db.Uuid
  provider   SocialProvider
  providerId String
  email      String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@map("social_accounts")
}

model DeviceToken {
  id        String         @id @default(uuid()) @db.Uuid
  userId    String         @db.Uuid
  token     String
  platform  DevicePlatform
  isActive  Boolean        @default(true)
  createdAt DateTime       @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("device_tokens")
}

model Provider {
  id                 String             @id @default(uuid()) @db.Uuid
  userId             String             @unique @db.Uuid
  bio                String?
  verificationStatus VerificationStatus @default(PENDING_DOCUMENTS)
  rating             Decimal            @default(0) @db.Decimal(3, 2)
  totalReviews       Int                @default(0)
  totalBookings      Int                @default(0)
  address            String?
  latitude           Decimal?           @db.Decimal(10, 7)
  longitude          Decimal?           @db.Decimal(10, 7)
  approvedAt         DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  // Relations
  user           User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents      ProviderDocument[]
  backgroundCheck BackgroundCheck?
  bankAccount    BankAccount?
  availability   ProviderAvailability[]
  services       ProviderService[]
  bookings       Booking[]              @relation("ProviderBookings")
  reviews        Review[]

  @@map("providers")
}

model ProviderDocument {
  id              String         @id @default(uuid()) @db.Uuid
  providerId      String         @db.Uuid
  type            DocumentType
  url             String
  status          DocumentStatus @default(PENDING)
  rejectionReason String?
  uploadedAt      DateTime       @default(now())
  reviewedAt      DateTime?

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("provider_documents")
}

model BackgroundCheck {
  id                 String               @id @default(uuid()) @db.Uuid
  providerId         String               @unique @db.Uuid
  status             BackgroundCheckStatus @default(PENDING)
  policeCheck        Boolean?
  disciplinaryCheck  Boolean?
  fiscalCheck        Boolean?
  checkedAt          DateTime?
  expiresAt          DateTime?
  notes              String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("background_checks")
}

model BankAccount {
  id             String          @id @default(uuid()) @db.Uuid
  providerId     String          @unique @db.Uuid
  bankName       String
  accountType    BankAccountType
  accountNumber  String
  accountHolder  String
  documentType   DocumentIdType
  documentNumber String
  isVerified     Boolean         @default(false)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("bank_accounts")
}

model ProviderAvailability {
  id         String   @id @default(uuid()) @db.Uuid
  providerId String   @db.Uuid
  dayOfWeek  Int      // 0=Monday ... 6=Sunday
  startTime  String   // HH:mm format
  endTime    String   // HH:mm format
  isActive   Boolean  @default(true)

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("provider_availability")
}

model ServiceCategory {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  slug        String   @unique
  description String
  iconUrl     String?
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  services Service[]
  bookings Booking[]

  @@map("service_categories")
}

model Service {
  id          String   @id @default(uuid()) @db.Uuid
  categoryId  String   @db.Uuid
  name        String
  slug        String   @unique
  description String
  basePrice   Decimal? @db.Decimal(12, 2)
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category         ServiceCategory   @relation(fields: [categoryId], references: [id])
  providerServices ProviderService[]
  bookings         Booking[]

  @@map("services")
}

model ProviderService {
  id          String  @id @default(uuid()) @db.Uuid
  providerId  String  @db.Uuid
  serviceId   String  @db.Uuid
  price       Decimal @db.Decimal(12, 2)
  description String?
  isActive    Boolean @default(true)

  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  service  Service  @relation(fields: [serviceId], references: [id])

  @@unique([providerId, serviceId])
  @@map("provider_services")
}

model Booking {
  id                String        @id @default(uuid()) @db.Uuid
  clientId          String        @db.Uuid
  providerId        String?       @db.Uuid
  serviceId         String?       @db.Uuid
  categoryId        String?       @db.Uuid
  status            BookingStatus @default(REQUESTED)
  address           String
  latitude          Decimal       @db.Decimal(10, 7)
  longitude         Decimal       @db.Decimal(10, 7)
  scheduledAt       DateTime
  description       String
  quotedPrice       Decimal?      @db.Decimal(12, 2)
  quotedMaterials   Decimal?      @db.Decimal(12, 2)
  estimatedDuration Int?          // minutes
  quoteNote         String?
  startedAt         DateTime?
  completedAt       DateTime?
  cancelledAt       DateTime?
  cancellationReason String?
  cancelledBy       CancelledBy?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  client        User                   @relation("ClientBookings", fields: [clientId], references: [id])
  provider      Provider?              @relation("ProviderBookings", fields: [providerId], references: [id])
  service       Service?               @relation(fields: [serviceId], references: [id])
  category      ServiceCategory?       @relation(fields: [categoryId], references: [id])
  statusHistory BookingStatusHistory[]
  payment       Payment?
  evidences     Evidence[]
  review        Review?
  pqrsTickets   PqrsTicket[]
  chatMessages  ChatMessage[]

  @@index([clientId, status])
  @@index([providerId, status])
  @@index([scheduledAt])
  @@map("bookings")
}

model BookingStatusHistory {
  id         String        @id @default(uuid()) @db.Uuid
  bookingId  String        @db.Uuid
  fromStatus BookingStatus?
  toStatus   BookingStatus
  changedBy  String        @db.Uuid
  note       String?
  createdAt  DateTime      @default(now())

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [changedBy], references: [id])

  @@map("booking_status_history")
}

model Payment {
  id               String        @id @default(uuid()) @db.Uuid
  bookingId        String        @unique @db.Uuid
  externalId       String?       @unique
  method           PaymentMethod?
  status           PaymentStatus @default(PENDING)
  amount           Decimal       @db.Decimal(12, 2)
  commissionRate   Decimal       @db.Decimal(5, 4) // e.g., 0.1500 = 15%
  commissionAmount Decimal       @db.Decimal(12, 2)
  providerAmount   Decimal       @db.Decimal(12, 2)
  currency         String        @default("COP")
  paidAt           DateTime?
  capturedAt       DateTime?
  refundedAt       DateTime?
  refundAmount     Decimal?      @db.Decimal(12, 2)
  metadata         Json?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id])

  @@map("payments")
}

model Evidence {
  id           String       @id @default(uuid()) @db.Uuid
  bookingId    String       @db.Uuid
  type         EvidenceType
  url          String
  thumbnailUrl String?
  mimeType     String
  sizeBytes    Int
  metadata     Json?        // GPS coords, timestamp, device info
  uploadedBy   String       @db.Uuid
  createdAt    DateTime     @default(now())

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [uploadedBy], references: [id])

  @@map("evidences")
}

model Review {
  id         String   @id @default(uuid()) @db.Uuid
  bookingId  String   @unique @db.Uuid
  clientId   String   @db.Uuid
  providerId String   @db.Uuid
  rating     Int      // 1-5
  comment    String
  createdAt  DateTime @default(now())

  booking  Booking  @relation(fields: [bookingId], references: [id])
  client   User     @relation(fields: [clientId], references: [id])
  provider Provider @relation(fields: [providerId], references: [id])

  @@map("reviews")
}

model PqrsTicket {
  id             String              @id @default(uuid()) @db.Uuid
  radicado       String              @unique // PQRS-2026-XXXXXX
  bookingId      String?             @db.Uuid
  createdById    String              @db.Uuid
  assignedToId   String?             @db.Uuid
  type           PqrsType
  category       String
  subject        String
  status         PqrsStatus          @default(OPEN)
  priority       PqrsPriority        @default(MEDIUM)
  resolution     String?
  resolutionType PqrsResolutionType?
  refundAmount   Decimal?            @db.Decimal(12, 2)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  resolvedAt     DateTime?
  closedAt       DateTime?
  reopenCount    Int                 @default(0)

  booking    Booking?      @relation(fields: [bookingId], references: [id])
  createdBy  User          @relation("PqrsCreatedBy", fields: [createdById], references: [id])
  assignedTo User?         @relation("PqrsAssignedTo", fields: [assignedToId], references: [id])
  messages   PqrsMessage[]

  @@map("pqrs_tickets")
}

model PqrsMessage {
  id         String     @id @default(uuid()) @db.Uuid
  ticketId   String     @db.Uuid
  senderId   String     @db.Uuid
  senderRole SenderRole
  content    String
  createdAt  DateTime   @default(now())

  ticket      PqrsTicket       @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  sender      User             @relation(fields: [senderId], references: [id])
  attachments PqrsAttachment[]

  @@map("pqrs_messages")
}

model PqrsAttachment {
  id        String   @id @default(uuid()) @db.Uuid
  messageId String   @db.Uuid
  url       String
  mimeType  String
  sizeBytes Int
  createdAt DateTime @default(now())

  message PqrsMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@map("pqrs_attachments")
}

model SystemConfig {
  id        String   @id @default("default")
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt

  @@map("system_config")
}

model Notification {
  id     String           @id @default(uuid()) @db.Uuid
  userId String           @db.Uuid
  type   NotificationType
  title  String
  body   String
  data   Json?            // Deep link data
  isRead Boolean          @default(false)
  sentAt DateTime         @default(now())
  readAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@map("notifications")
}

model ChatMessage {
  id        String          @id @default(uuid()) @db.Uuid
  bookingId String          @db.Uuid
  senderId  String          @db.Uuid
  content   String
  type      ChatMessageType @default(TEXT)
  imageUrl  String?
  isRead    Boolean         @default(false)
  createdAt DateTime        @default(now())

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  sender  User    @relation(fields: [senderId], references: [id])

  @@index([bookingId, createdAt])
  @@map("chat_messages")
}
